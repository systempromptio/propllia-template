<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proplia Demo - Remesas SEPA</title>
    <link rel="stylesheet" href="/css/admin.css">
    <script>window.ADMIN_API_BASE = '/admin/api';</script>
</head>
<body>
<div style="background: linear-gradient(90deg, #2B4C7E, #1F3A63); color: white; text-align: center; padding: 8px 16px; font-size: 13px; font-family: 'Inter', system-ui, sans-serif;">
    Modo demostración — Los datos mostrados son ficticios
</div>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <a href="/" class="admin-sidebar-brand">
                <span style="font-family: 'Inter', system-ui, sans-serif; font-size: 20px; font-weight: 700; color: #2B4C7E; letter-spacing: -0.5px;">Proplia</span>
<span style="display: block; font-size: 11px; color: #718096; margin-top: 2px;">Gestión Inmobiliaria</span>
            </a>
            <nav>
                <div class="nav-label">General</div>
                <a href="/demo/">
                    <svg class="icon" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
                    Panel
                </a>
                <div class="nav-label">Gestión</div>
                <a href="/demo/activos">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 14V7l6-5 6 5v7h-4v-4H6v4H2z"/></svg>
                    Activos
                </a>
                <a href="/demo/contratos">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 1h6l3 3v11H4V1z"/><path d="M10 1v3h3"/><line x1="6" y1="7" x2="11" y2="7"/><line x1="6" y1="10" x2="11" y2="10"/></svg>
                    Contratos
                </a>
                <a href="/demo/contabilidad">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3.5C11 2.5 9.5 2 8 2 5 2 2.5 4.5 2.5 8s2.5 6 5.5 6c1.5 0 3-.5 4-1.5"/><line x1="1" y1="7" x2="9" y2="7"/><line x1="1" y1="9.5" x2="9" y2="9.5"/></svg>
                    Contabilidad
                </a>
                <a href="/demo/inquilinos">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="5" r="3"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6"/></svg>
                    Inquilinos
                </a>
                <a href="/demo/propietarios">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="5" r="3"/><path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6"/><path d="M11 2l1.5 1.5L11 5" stroke-width="1.2"/></svg>
                    Propietarios
                </a>
                <a href="/demo/depositos">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="12" height="10" rx="1.5"/><path d="M2 7h12"/><rect x="4" y="9" width="4" height="2" rx="0.5"/></svg>
                    Depósitos
                </a>
                <a href="/demo/remesas_sepa" class="active">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 4h14M1 8h14M1 12h10"/><circle cx="13" cy="12" r="2"/></svg>
                    Remesas SEPA
                </a>
                <a href="/demo/incidencias">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M10.3 1.7a4 4 0 0 0-4.8 5.3L1.7 10.8a1.5 1.5 0 0 0 0 2.1l1.4 1.4a1.5 1.5 0 0 0 2.1 0L9 10.5a4 4 0 0 0 5.3-4.8L12 8l-2-1-1-2z"/></svg>
                    Incidencias
                </a>
                <a href="/demo/overdue">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 1L1 14h14L8 1z"/><line x1="8" y1="6" x2="8" y2="9.5"/><circle cx="8" cy="11.5" r="0.7" fill="currentColor"/></svg>
                    Impagos
                </a>
                <div class="nav-label">Análisis</div>
                <a href="/demo/financial">
                    <svg class="icon" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="14" width="14" height="1" opacity="0.3"/><rect x="2" y="9" width="3" height="5" rx="0.5" opacity="0.5"/><rect x="6.5" y="5" width="3" height="9" rx="0.5" opacity="0.7"/><rect x="11" y="2" width="3" height="12" rx="0.5"/></svg>
                    Finanzas
                </a>
                <a href="/demo/audit">
                    <svg class="icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="6"/><path d="M8 4v4l3 2"/></svg>
                    Auditoría
                </a>
            </nav>
        </aside>
        <main class="admin-main">
            <div class="admin-header">
                <h1>Remesas SEPA</h1>
                <a href="/" style="margin-left:auto; padding:6px 16px; border:1px solid var(--border-color,#e2e8f0); border-radius:6px; background:transparent; color:var(--text-secondary,#718096); text-decoration:none; font-size:13px;">
    ← Volver al sitio
</a>
            </div>
                <div id="table-root"></div>
        </main>
    </div>
    <footer style="text-align:center; padding:16px 0; color:#a0aec0; font-size:13px;">
        powered by <a href="/" style="color:#a0aec0; text-decoration:underline;">Proplia</a> — <a href="https://systemprompt.io" target="_blank" rel="noopener" style="color:#a0aec0; text-decoration:underline;">systemprompt.io</a>
    </footer>
    <script src="/js/demo-mock.js"></script>
<script src="/js/admin.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const { DataTable, FormPanel, HistoryPanel, Toast, api, confirmAction } = AdminApp;
                Toast.init();
                const historyPanel = new HistoryPanel();

                const formFields = [
                    { key: 'fecha_cobro', label: 'Fecha de cobro', type: 'date', required: true },
                    { key: 'acreedor', label: 'Acreedor', required: true, placeholder: 'Nombre del acreedor' },
                    { key: 'acreedor_iban', label: 'IBAN acreedor', placeholder: 'ES00 0000 0000 0000 0000 0000' },
                    { key: 'importe', label: 'Importe', type: 'number', required: true, placeholder: '0.00' },
                    { key: 'moneda', label: 'Moneda', placeholder: 'EUR' },
                    { key: 'deudor', label: 'Deudor', required: true, placeholder: 'Nombre del deudor' },
                    { key: 'deudor_iban', label: 'IBAN deudor', placeholder: 'ES00 0000 0000 0000 0000 0000' },
                    { key: 'mandato_id', label: 'ID mandato', placeholder: 'Referencia mandato SEPA' },
                    { key: 'remesa_id', label: 'ID remesa', placeholder: 'Identificador remesa SEPA' },
                    { key: 'referencia', label: 'Referencia', placeholder: 'Referencia de pago' },
                    { key: 'archivo', label: 'Archivo origen', placeholder: 'Ruta del archivo XML' },
                ];

                const formPanel = new FormPanel({
                    title: 'Remesa SEPA',
                    fields: formFields,
                    onSubmit: async (data, isEdit, original) => {
                        try {
                            if (isEdit) {
                                await api.put(`/remesas_sepa/${original.id}`, data);
                                Toast.show('Remesa actualizada');
                            } else {
                                await api.post('/remesas_sepa', data);
                                Toast.show('Remesa creada');
                            }
                            table.load();
                        } catch (e) {
                            Toast.show(e.message, 'error');
                        }
                    }
                });

                const table = new DataTable('#table-root', {
                    entity: 'remesa_sepa',
                    apiPath: '/remesas_sepa',
                    showPeriodFilter: true,
                    columns: [
                        { key: 'fecha_cobro', label: 'Fecha cobro', type: 'date' },
                        { key: 'acreedor', label: 'Acreedor' },
                        { key: 'deudor', label: 'Deudor' },
                        { key: 'importe', label: 'Importe', type: 'currency' },
                        { key: 'moneda', label: 'Moneda' },
                        { key: 'referencia', label: 'Referencia' },
                        { key: 'created_at', label: 'Creado', type: 'date' },
                    ],
                    onRowClick: (row) => {
                        formPanel.open(row);
                    },
                    onAction: async (action, row) => {
                        if (action === 'create') formPanel.open();
                        if (action === 'edit') formPanel.open(row);
                        if (action === 'history') historyPanel.open('remesas_sepa', row.id);
                        if (action === 'delete') {
                            const ok = await confirmAction('Eliminar remesa', `¿Eliminar remesa de "${row.deudor}"? Esta acción no se puede deshacer.`);
                            if (ok) {
                                try {
                                    await api.del(`/remesas_sepa/${row.id}`);
                                    Toast.show('Remesa eliminada');
                                    table.load();
                                } catch (e) { Toast.show(e.message, 'error'); }
                            }
                        }
                    }
                });

                // Add SEPA XML download button to the toolbar
                const toolbar = document.querySelector('#table-root .toolbar');
                if (toolbar) {
                    const createBtn = toolbar.querySelector('[data-action="create"]');
                    const xmlBtn = document.createElement('button');
                    xmlBtn.className = 'btn btn-secondary';
                    xmlBtn.textContent = '\u2913 Descargar SEPA XML';
                    xmlBtn.addEventListener('click', () => {
                        const params = new URLSearchParams();
                        if (table.searchQuery) params.set('search', table.searchQuery);
                        Object.entries(table.filterValues).forEach(([k, v]) => {
                            if (v && k !== '_period') params.set(k, v);
                        });
                        const qs = params.toString();
                        const url = `${window.ADMIN_API_BASE}/export/remesas_sepa_xml${qs ? '?' + qs : ''}`;
                        window.open(url, '_blank');
                    });
                    toolbar.insertBefore(xmlBtn, createBtn);
                }
            });
        </script>
</body>
</html>
