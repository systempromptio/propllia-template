                <div id="table-root"></div>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const { DataTable, FormPanel, HistoryPanel, Toast, api, confirmAction } = AdminApp;
                Toast.init();
                const historyPanel = new HistoryPanel();

                const formFields = [
                    { key: 'fecha_cobro', label: 'Fecha de cobro', type: 'date', required: true },
                    { key: 'acreedor', label: 'Acreedor', required: true, placeholder: 'Nombre del acreedor' },
                    { key: 'acreedor_iban', label: 'IBAN acreedor', placeholder: 'ES00 0000 0000 0000 0000 0000' },
                    { key: 'importe', label: 'Importe', type: 'number', required: true, placeholder: '0.00' },
                    { key: 'moneda', label: 'Moneda', placeholder: 'EUR' },
                    { key: 'deudor', label: 'Deudor', required: true, placeholder: 'Nombre del deudor' },
                    { key: 'deudor_iban', label: 'IBAN deudor', placeholder: 'ES00 0000 0000 0000 0000 0000' },
                    { key: 'mandato_id', label: 'ID mandato', placeholder: 'Referencia mandato SEPA' },
                    { key: 'remesa_id', label: 'ID remesa', placeholder: 'Identificador remesa SEPA' },
                    { key: 'referencia', label: 'Referencia', placeholder: 'Referencia de pago' },
                    { key: 'archivo', label: 'Archivo origen', placeholder: 'Ruta del archivo XML' },
                ];

                const formPanel = new FormPanel({
                    title: 'Remesa SEPA',
                    fields: formFields,
                    onSubmit: async (data, isEdit, original) => {
                        try {
                            if (isEdit) {
                                await api.put(`/remesas_sepa/${original.id}`, data);
                                Toast.show('Remesa actualizada');
                            } else {
                                await api.post('/remesas_sepa', data);
                                Toast.show('Remesa creada');
                            }
                            table.load();
                        } catch (e) {
                            Toast.show(e.message, 'error');
                        }
                    }
                });

                const table = new DataTable('#table-root', {
                    entity: 'remesa_sepa',
                    apiPath: '/remesas_sepa',
                    showPeriodFilter: true,
                    columns: [
                        { key: 'fecha_cobro', label: 'Fecha cobro', type: 'date' },
                        { key: 'acreedor', label: 'Acreedor' },
                        { key: 'deudor', label: 'Deudor' },
                        { key: 'importe', label: 'Importe', type: 'currency' },
                        { key: 'moneda', label: 'Moneda' },
                        { key: 'referencia', label: 'Referencia' },
                        { key: 'created_at', label: 'Creado', type: 'date' },
                    ],
                    onRowClick: (row) => {
                        formPanel.open(row);
                    },
                    onAction: async (action, row) => {
                        if (action === 'create') formPanel.open();
                        if (action === 'edit') formPanel.open(row);
                        if (action === 'history') historyPanel.open('remesas_sepa', row.id);
                        if (action === 'delete') {
                            const ok = await confirmAction('Eliminar remesa', `¿Eliminar remesa de "${row.deudor}"? Esta acción no se puede deshacer.`);
                            if (ok) {
                                try {
                                    await api.del(`/remesas_sepa/${row.id}`);
                                    Toast.show('Remesa eliminada');
                                    table.load();
                                } catch (e) { Toast.show(e.message, 'error'); }
                            }
                        }
                    }
                });

                // Add SEPA XML download button to the toolbar
                const toolbar = document.querySelector('#table-root .toolbar');
                if (toolbar) {
                    const createBtn = toolbar.querySelector('[data-action="create"]');
                    const xmlBtn = document.createElement('button');
                    xmlBtn.className = 'btn btn-secondary';
                    xmlBtn.textContent = '⤓ Descargar SEPA XML';
                    xmlBtn.addEventListener('click', () => {
                        const params = new URLSearchParams();
                        if (table.searchQuery) params.set('search', table.searchQuery);
                        Object.entries(table.filterValues).forEach(([k, v]) => {
                            if (v && k !== '_period') params.set(k, v);
                        });
                        const qs = params.toString();
                        const url = `${window.ADMIN_API_BASE}/export/remesas_sepa_xml${qs ? '?' + qs : ''}`;
                        window.open(url, '_blank');
                    });
                    toolbar.insertBefore(xmlBtn, createBtn);
                }
            });
        </script>
