# Feature: Facturación (Invoicing)

slug: "facturacion"
title: "Facturación - Generación automática"
icon: "receipt"
headline: "Facturación"
headline_highlight: "automática mensual"
subtitle: "Generación automática de facturas el día 1 de cada mes con PDF, 6 estados de seguimiento, descuentos y clasificación de ingresos/gastos."

highlights:
  - id: "automatica"
    text: "Generación automática mensual"
  - id: "pdf"
    text: "Facturas en PDF"
  - id: "estados"
    text: "6 estados de seguimiento"
  - id: "descuentos"
    text: "Descuentos fijos y porcentuales"

sections:
  - id: "automatica"
    title: "Generación automática"
    visual_position: "right"
    visual_svg: |
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <!-- Calendar page -->
        <rect x="80" y="70" width="150" height="170" rx="8"/>
        <!-- Calendar header bar -->
        <line x1="80" y1="110" x2="230" y2="110"/>
        <!-- Calendar binding dots -->
        <circle cx="120" cy="70" r="4" fill="currentColor"/>
        <circle cx="190" cy="70" r="4" fill="currentColor"/>
        <!-- Grid lines on calendar -->
        <line x1="130" y1="110" x2="130" y2="240"/>
        <line x1="180" y1="110" x2="180" y2="240"/>
        <line x1="80" y1="150" x2="230" y2="150"/>
        <line x1="80" y1="195" x2="230" y2="195"/>
        <!-- Checkmark on calendar -->
        <polyline points="135,165 150,180 175,145" stroke-width="2.5"/>
        <!-- Arrow indicating automation -->
        <line x1="250" y1="155" x2="330" y2="155"/>
        <polyline points="320,145 335,155 320,165"/>
        <!-- Small document at end of arrow -->
        <rect x="340" y="135" width="40" height="50" rx="4"/>
        <line x1="350" y1="150" x2="370" y2="150"/>
        <line x1="350" y1="162" x2="365" y2="162"/>
      </svg>
    content: |
      <p>El job programado <code>generar_facturas_mensuales</code> se ejecuta el día 1 de cada mes a las 6:00 AM y genera todas las facturas sin intervención manual:</p>
      <ol>
        <li>Busca todos los contratos con estado <strong>"Firmado"</strong></li>
        <li>Genera una factura por cada contrato activo</li>
        <li>Asigna el concepto <em>"Alquiler [mes] [año]"</em></li>
        <li>Establece el importe desde el campo <code>alquiler</code> del contrato</li>
        <li>Estado inicial: <strong>"Emitida"</strong></li>
      </ol>
      <p>Cada factura almacena 25 campos incluyendo referencia, concepto, pagador, receptor, importes, IVA, moneda, método de pago y clasificación contable.</p>

  - id: "pdf"
    title: "Facturas en PDF"
    content: |
      <p>Cada factura puede generar su PDF profesional con el endpoint <code>GET /admin/api/contabilidad/{id}/pdf</code>. Los documentos se generan con <code>genpdf</code> (librería Rust nativa) e incluyen:</p>
      <ul>
        <li>Datos del propietario (nombre, dirección, CIF)</li>
        <li>Datos del inquilino (nombre, dirección, NIF)</li>
        <li>Inmueble asociado con dirección completa</li>
        <li>Desglose de conceptos y líneas de factura</li>
        <li>Importes parciales, descuentos, IVA y total</li>
      </ul>

  - id: "estados"
    title: "6 estados de seguimiento"
    visual_position: "left"
    visual_svg: |
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <!-- 6 circles in sequence representing status pipeline -->
        <circle cx="45" cy="150" r="16"/>
        <circle cx="115" cy="150" r="16"/>
        <circle cx="185" cy="150" r="16"/>
        <circle cx="255" cy="150" r="16"/>
        <circle cx="325" cy="150" r="16"/>
        <circle cx="370" cy="150" r="12"/>
        <!-- Connecting lines -->
        <line x1="61" y1="150" x2="99" y2="150"/>
        <line x1="131" y1="150" x2="169" y2="150"/>
        <line x1="201" y1="150" x2="239" y2="150"/>
        <line x1="271" y1="150" x2="309" y2="150"/>
        <line x1="341" y1="150" x2="358" y2="150"/>
        <!-- Arrow tips on lines -->
        <polyline points="95,145 101,150 95,155"/>
        <polyline points="165,145 171,150 165,155"/>
        <polyline points="235,145 241,150 235,155"/>
        <polyline points="305,145 311,150 305,155"/>
        <!-- First circle filled to show starting state -->
        <circle cx="45" cy="150" r="6" fill="currentColor"/>
      </svg>
    content: |
      <p>Controla el ciclo completo de cada factura con estados claros y transiciones automáticas.</p>
      <p>Las vistas SQL <code>v_contabilidad_pendiente</code> filtra facturas "Sin pagar" o "Parcial" para seguimiento de morosidad. Las vistas <code>v_resumen_por_activo</code> y <code>v_resumen_por_receptor</code> agregan totales financieros por inmueble y por acreedor.</p>
    items:
      - title: "Emitida"
        description: "Factura generada, pendiente de envío al pagador"
      - title: "Enviada"
        description: "Factura entregada al inquilino"
      - title: "Sin pagar"
        description: "Plazo de pago vencido sin cobro"
      - title: "Parcial"
        description: "Pago parcial recibido, pendiente del resto"
      - title: "Pagado"
        description: "Factura completamente liquidada"
      - title: "Vencida"
        description: "Impago confirmado, entra en seguimiento de morosidad"

  - id: "descuentos"
    title: "Descuentos y clasificación contable"
    content: |
      <p>Aplica descuentos flexibles a cualquier factura combinando dos tipos:</p>
      <ul>
        <li><strong>descuento</strong> — Importe fijo en euros (ej: 50€ de bonificación)</li>
        <li><strong>descuento_pct</strong> — Porcentaje sobre el total (ej: 10% por pronto pago)</li>
      </ul>
      <p>El campo <code>tipo</code> clasifica cada registro como <strong>Ingreso</strong> (alquileres, fianzas) o <strong>Gasto</strong> (IBI, comunidad, seguros, mantenimiento). El campo <code>tipo_gasto</code> permite categorizar los gastos para informes financieros detallados.</p>
      <p>Exporta todas las facturas en CSV con <code>GET /admin/api/export/contabilidad</code>.</p>

related:
  - title: "Banca y SEPA"
    description: "Cobra las facturas por domiciliación bancaria SEPA."
    url: "/features/banca-sepa"
  - title: "Contratos LAU"
    description: "Las facturas se generan a partir de los contratos activos."
    url: "/features/contratos-lau"
  - title: "Informes"
    description: "Analiza ingresos, morosidad y rentabilidad por inmueble."
    url: "/features/informes"
